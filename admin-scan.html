<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shadow Motorclub - Scannen & Handmatig</title>
    <style>
      html,body{height:100%;margin:0;background:#0b0c10}
      .app-splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:20000;background:#0b0c10}
      .splash-inner{width:92vw;text-align:center;padding:20px}
      .splash-logo{width:110px;height:auto;margin:0 auto 12px;display:block}
      .splash-progress{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin:10px 0}
      .splash-progress-bar{height:100%;background:linear-gradient(90deg,#3b82f6,#06b6d4);width:0%;transition:width .3s ease}
      
      /* Inklapbare pijl: links (ingeklapt) ‚Üí onder (uitgeklapt) */
      details summary .toggle-icon {
        transform: rotate(-90deg);
      }
      details[open] summary .toggle-icon {
        transform: rotate(0deg);
      }
      details summary::-webkit-details-marker {
        display: none;
      }
      details summary::marker {
        display: none;
      }
    </style>
    <link rel="stylesheet" href="/style.css">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="assets/logo_MC_nieuw_trans_300.gif">
    <meta name="theme-color" content="#0f172a">
  <!-- html5-qrcode is loaded dynamically only when needed (avoid double-loading) -->
  <!-- Chart.js is loaded dynamically by the stats page when needed -->
  <!-- Preload main module to warm the module graph (helps vite/multi-page module startup) -->
  <link rel="modulepreload" href="/src/main.js">
  </head>
  <body>
    <div id="appSplash" class="app-splash" aria-hidden="false">
      <div class="splash-inner">
        <img src="assets/logo_MC_nieuw_trans_300.gif" alt="Shadow" class="splash-logo" />
        <div class="splash-title">Shadow Motorclub</div>
        <div class="splash-progress">
          <div class="splash-progress-bar" id="splashProgressBar" style="width:0%"></div>
        </div>
        <div class="splash-caption" id="splashCaption">Laden‚Ä¶</div>
      </div>
    </div>
    
    <header class="topbar">
      <img id="clubLogo" src="assets/logo_MC_nieuw_trans_300.gif" alt="Shadow Motorclub logo" width="100" height="30" />
      <nav class="nav">
        <a href="index.html" class="tab">Lid</a>
        <a href="admin-scan.html" class="tab active">Inschrijftafel</a>
      </nav>
    </header>

    <main class="wrap">
      <div class="admin-nav-dropdown">
        <select id="adminNavSelect" class="admin-nav-select">
          <option value="admin-scan.html" selected>Inschrijftafel</option>
          <option value="admin-planning.html">Begin van het jaar</option>
          <option value="admin-passwords.html">Wachtwoorden</option>
          <option value="admin-stats.html">Ritten data</option>
          <option value="admin-lunch.html">Lunch inplannen</option>
          <option value="admin-dev.html">Dev</option>
        </select>
      </div>

      <section id="viewAdmin" class="view active">
        <div class="card" id="qrScanCard">
          <h3>QR code scannen</h3>
          <p class="muted">Gebruik de camera om QR-codes te scannen en direct gegevens te verwerken.</p>
          <div class="row" style="gap:12px; align-items:center;">
            <button id="adminScanStart" class="btn">üì∑ Start scanner</button>
            <button id="adminScanStop" class="btn btn-ghost">‚è∏Ô∏è Stop</button>
            <span id="adminQRStatus" class="status"></span>
          </div>
          <div id="adminQRReader" class="qr-reader" style="margin-top:12px;"></div>
          <div id="adminQRResult" class="muted" style="margin-top:8px;"></div>
        </div>

        <!-- Vervangen door exacte inschrijven-rit sectie van index.html -->
        <section id="landelijkeSignup" data-ride-signup="true" hidden>
          <div class="card" id="manualRideCard">
            <h1>Handmatig inschrijven</h1>
            <p class="hint">Zoek op achternaam of voornaam (Hoofletter gevoelig).</p>
            
            <div class="row">
              <input id="nameInput" placeholder="achternaam of voornaam" />
            </div>
            
            <!-- Lunch keuze sectie -->
            <div id="lunchChoiceSection" style="display:none; margin-top:24px;">
              <details open style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: 12px; padding: 20px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <summary style="cursor: pointer; list-style: none; user-select: none; display: flex; align-items: center; gap: 12px;">
                  <div style="flex: 1;">
                    <h3 style="margin: 0; font-size: 20px;">Lunch deelname</h3>
                    <p style="margin: 4px 0 0 0; color: var(--muted); font-size: 14px;">
                      <span id="lunchSummaryText">Vraag of de deelnemer mee-eet tijdens de lunch</span>
                    </p>
                    <span id="lunchSelectionBadge" style="display: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; white-space: nowrap;"></span>
                  </div>
                  <span class="toggle-icon" style="font-size: 24px; transition: transform 0.3s ease;">‚ñº</span>
                </summary>
                
                <div class="lunch-content" style="margin-top: 16px;">
                  <!-- Disclaimer wanneer gescand -->
                  <div id="lunchScannedDisclaimer" style="display: none; padding: 12px; margin-bottom: 16px; background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 18px;">‚ÑπÔ∏è</span>
                      <div>
                        <strong style="color: #fbbf24; font-size: 14px;">Let op:</strong>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--muted); line-height: 1.5;">
                          U bent al ingecheckt voor deze rit. Uw lunch keuze kan niet meer worden gewijzigd.
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Lunch details (alleen zichtbaar bij "Ja") - BOVEN vast menu -->
                  <div id="lunchDetailsSection" style="display:none; margin-bottom:20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <div id="keuzeEtenSection" style="margin-bottom:0;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 20px;">üç¥</span>
                        <strong style="font-size: 15px;">Vraag welk eten de deelnemer wil:</strong>
                      </div>
                      <div id="keuzeEtenButtons" style="display:flex; flex-wrap:wrap; gap:10px;">
                        <!-- Dynamische keuze buttons komen hier -->
                      </div>
                    </div>
                  </div>
                  
                  <!-- Vast menu voor iedereen (altijd zichtbaar) -->
                  <div style="margin-bottom:20px; background: rgba(255, 255, 255, 0.03); padding: 14px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                      <span style="font-size: 20px;">ü•ñ</span>
                      <strong style="font-size: 15px;">Vast menu voor iedereen:</strong>
                    </div>
                    <p id="vastEtenDisplay" class="muted" style="margin:0; font-size: 14px; line-height: 1.6;">Laden...</p>
                  </div>
                  
                  <div class="seg-wrap">
                    <div class="seg-toggle" id="lunchToggle" role="radiogroup" aria-label="Lunch keuze" style="width: 100%;">
                      <button type="button" id="lunchYes" class="seg-btn" role="radio" aria-checked="false" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600;">
                        ‚úì Ja, ik eet mee
                      </button>
                      <button type="button" id="lunchNo" class="seg-btn" role="radio" aria-checked="false" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600;">
                        ‚úï Nee, bedankt
                      </button>
                    </div>
                  </div>
                  
                  <!-- Informatieve melding over deadline (altijd zichtbaar) -->
                  <div id="lunchDeadlineInfo" style="padding: 12px; margin-top: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 18px;">üí°</span>
                      <div>
                        <strong style="color: #3b82f6; font-size: 14px;">Belangrijk:</strong>
                        <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--muted); line-height: 1.5;">
                          Zeg dat de deelnemer zijn lunch keuze <strong>v√≥√≥r het inchecken</strong> moet maken. Na het inchecken kan de keuze niet meer worden gewijzigd.
                        </p>
                      </div>
                    </div>
                  </div>
              </details>
            </div>
            
            <div id="yearhangerRow" style="margin-top:8px; display:none;">
              <details open style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: 12px; padding: 20px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <summary style="cursor: pointer; list-style: none; user-select: none; display: flex; align-items: center; gap: 12px;">
                  <div style="flex: 1;">
                    <h3 style="margin: 0; font-size: 20px;">Jaarhanger</h3>
                    <p class="muted" style="margin: 4px 0 0 0; font-size: 14px;">Vraag of de deelnemer een jaarhanger wil</p>
                    <span id="jaarhangerSelectionBadge" style="display: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; white-space: nowrap;"></span>
                  </div>
                  <span class="toggle-icon" style="font-size: 24px; transition: transform 0.3s ease;">‚ñº</span>
                </summary>

                <div class="jaarhanger-content" style="margin-top: 16px;">
                  <div class="seg-wrap">
                    <div class="seg-toggle" id="yearhangerToggle" role="radiogroup" aria-label="Jaarhanger" style="width: 100%; display: flex; flex-direction: row; gap: 0; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 10px; overflow: hidden;">
                      <button type="button" id="yearhangerYes" class="seg-btn" role="radio" aria-checked="false" style="width: 50%; padding: 14px; font-size: 16px; font-weight: 600; border: none;">
                        ‚úì Ja
                      </button>
                      <button type="button" id="yearhangerNo" class="seg-btn" role="radio" aria-checked="false" style="width: 50%; padding: 14px; font-size: 16px; font-weight: 600; border: none; border-left: 1px solid rgba(255, 255, 255, 0.15);">
                        ‚úï Nee
                      </button>
                    </div>
                  </div>

                  <div id="jaarhangerInfo" style="display:none; margin: 16px 0 8px 0;">
                    <details class="muted" style="margin-top:4px;">
                      <summary>Wat is een jaarhanger?</summary>
                      <div style="margin-top:8px;">
                        Het aantal sterren geeft aan hoeveel landelijke ritten je dat jaar gereden hebt. De "moederpin" kan je als Shadow lid bestellen in de webshop, zodat je jouw jaarhangers mooi op je vest kwijt kunt. De jaarhangers zijn niet te koop en kan je alleen verdienen door mee te rijden met de landelijke ritten. Da's pas een collectors item!
                      </div>
                    </details>
                  </div>
                </div>
              </details>
            </div>

            <ul id="suggestions" class="suggest"></ul>
            <div id="error" class="error" style="display:none"></div>
            <div id="loadingIndicator" class="loading-indicator" style="display:none;">
              <div class="spinner"></div>
              <span class="loading-text">Gegevens laden...</span>
            </div>
            <div id="result" class="result" style="display:none">
              <div class="column">
                <div class="kv"><span class="label">Naam</span><span class="value" id="rName">‚Äî</span></div>
                <div class="kv"><span class="label">LidNr</span><span class="value" id="rMemberNo">‚Äî</span></div>
                <div class="kv"><span class="label">Gereden ritten</span><span class="value" id="rRidesCount">‚Äî</span></div>
                <div class="kv"><span class="label">Regio</span><span class="value" id="rRegion">‚Äî</span></div>
                <div style="height:4px;"></div>
                <h4 style="margin: 8px 0 6px 0;">Eerdere ritten (handmatig boeken)</h4>
                <div id="manualPastRidesList" class="muted" style="display:grid; gap:8px;"></div>
                <div id="manualPastRidesStatus" class="small muted" style="min-height:18px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Lunch overzicht sectie -->
        <div class="card" id="cardLunchOverview" style="display: block !important;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 24px;">üìä</span>
            <div>
              <h3 style="margin: 0;">Lunch overzicht</h3>
              <p id="lunchOverviewDateTitle" class="muted" style="margin: 4px 0 0 0; font-size: 14px;">Eerstvolgende rit: ‚Äî</p>
            </div>
          </div>
          <div class="row" style="margin: 8px 0 12px; gap: 8px; align-items: center; flex-wrap: wrap;">
            <span id="lunchOverviewStatus" class="muted" style="min-height:20px;"></span>
          </div>

          <div class="row" style="margin: 6px 0 10px;">
            <div class="kv">
              <div class="label">Aantal eters</div>
              <div id="lunchTotalEaters" class="value">‚Äî</div>
            </div>
          </div>

          <div>
            <h4 id="lunchChoiceCountsTitle" style="margin: 10px 0 6px;">Keuzes (aantal)</h4>
            <div id="lunchChoiceCounts" style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
              <!-- Dynamisch gevuld -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

    <script type="module">
      import { checkAdminAuth, applyAdminLevel } from './src/auth.js';
  import { getPlannedDates } from './src/member.js';
  import { db, collection, orderBy, startAfter, limit, getDocs, query } from './src/firebase.js';
      
      // Dropdown navigation handler
      const navSelect = document.getElementById('adminNavSelect');
      if (navSelect) {
        navSelect.addEventListener('change', (e) => {
          window.location.href = e.target.value;
        });
      }

      // Check authentication before loading the page
      if (checkAdminAuth()) {
        // Apply admin level restrictions after DOM is ready
        setTimeout(() => {
          applyAdminLevel();
        }, 100);
      }

      // ===== Lunch overzicht (automatisch voor eerstvolgende rit) =====
      const lunchOverviewDateTitle = document.getElementById('lunchOverviewDateTitle');
      const lunchOverviewStatus = document.getElementById('lunchOverviewStatus');
      const lunchTotalEaters = document.getElementById('lunchTotalEaters');
      const lunchChoiceCounts = document.getElementById('lunchChoiceCounts');

      async function getNextPlannedRideYMD() {
        try {
          const planned = await getPlannedDates();
          const list = (Array.isArray(planned) ? planned : []).map(d => {
            if (typeof d === 'string' && /\d{4}-\d{2}-\d{2}/.test(d)) return d.slice(0,10);
            try {
              const dt = new Date(d);
              if (!isNaN(dt)) return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
            } catch(_) {}
            return '';
          }).filter(Boolean).sort();
          const today = new Date();
          const todayYMD = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
          // Kies de eerste datum die vandaag of later is
          const next = list.find(d => d >= todayYMD);
          return next || '';
        } catch (_) { return ''; }
      }

      async function computeLunchOverview() {
        try {
          if (lunchOverviewStatus) lunchOverviewStatus.textContent = 'Ritdatum ophalen‚Ä¶';
          const ymd = await getNextPlannedRideYMD();
          
          if (!ymd) {
            lunchTotalEaters.textContent = '‚Äî';
            lunchChoiceCounts.innerHTML = '';
            if (lunchOverviewDateTitle) lunchOverviewDateTitle.textContent = 'Geen eerstvolgende rit gepland';
            if (lunchOverviewStatus) lunchOverviewStatus.textContent = 'Geen toekomstige ritdatums';
            return;
          }
          
          // Toon de datum in de titel
          if (lunchOverviewDateTitle) lunchOverviewDateTitle.textContent = `Eerstvolgende rit: ${ymd}`;
          
          if (lunchOverviewStatus) lunchOverviewStatus.textContent = 'Tellen‚Ä¶';
          let totalYes = 0;
          const perChoice = new Map();

          let last = null;
          const pageSize = 400;
          while (true) {
            let qRef = null;
            if (last) {
              qRef = query(collection(db, 'members'), orderBy('__name__'), startAfter(last), limit(pageSize));
            } else {
              qRef = query(collection(db, 'members'), orderBy('__name__'), limit(pageSize));
            }
            const snap = await getDocs(qRef);
            if (snap.empty) break;

            snap.forEach(docSnap => {
              const d = docSnap.data() || {};
              const deel = (d.lunchDeelname || '').toString().toLowerCase();
              const dateMatch = (d.lunchRideDateYMD || '').toString().slice(0,10) === ymd;
              if (deel === 'ja' && dateMatch) {
                totalYes++;
                const keuzeRaw = (d.lunchKeuze || '').toString().trim();
                const key = keuzeRaw || 'Geen keuze';
                perChoice.set(key, (perChoice.get(key) || 0) + 1);
              }
            });

            last = snap.docs[snap.docs.length - 1];
            if (snap.size < pageSize) break;
          }

          // Render
          lunchTotalEaters.textContent = String(totalYes);
          lunchChoiceCounts.innerHTML = '';
          
          // Check of er alleen "Geen keuze" is (betekent: geen keuze-eten beschikbaar)
          const onlyNoChoice = perChoice.size === 1 && perChoice.has('Geen keuze');
          const lunchChoiceCountsTitle = document.getElementById('lunchChoiceCountsTitle');
          
          if (onlyNoChoice) {
            // Verberg de hele keuzes sectie als er alleen "Geen keuze" is
            if (lunchChoiceCountsTitle) lunchChoiceCountsTitle.style.display = 'none';
            lunchChoiceCounts.style.display = 'none';
          } else {
            // Toon de keuzes sectie
            if (lunchChoiceCountsTitle) lunchChoiceCountsTitle.style.display = 'block';
            lunchChoiceCounts.style.display = 'grid';
            
            if (perChoice.size === 0) {
              const empty = document.createElement('div');
              empty.className = 'muted';
              empty.style.gridColumn = '1 / -1';
              empty.textContent = 'Geen keuzes gevonden voor deze datum.';
              lunchChoiceCounts.appendChild(empty);
            } else {
              const entries = Array.from(perChoice.entries()).sort((a,b) => a[0].localeCompare(b[0]));
              for (const [name, count] of entries) {
                const l = document.createElement('div');
                l.textContent = name;
                const v = document.createElement('div');
                v.className = 'value';
                v.textContent = String(count);
                lunchChoiceCounts.appendChild(l);
                lunchChoiceCounts.appendChild(v);
              }
            }
          }
          if (lunchOverviewStatus) lunchOverviewStatus.textContent = '‚úÖ Gereed';
        } catch (e) {
          console.error('Overzicht tellen mislukt', e);
          if (lunchOverviewStatus) lunchOverviewStatus.textContent = '‚ùå Mislukt';
        }
      }

      // Init overview bij laden van de pagina
      computeLunchOverview();
    </script>
    
    <script type="module">
      // Handmatig boeken voor de leden-inschrijfsectie (vervangt QR in admin-scan)
  import { getPlannedDates } from './src/member.js';
  import { db, doc, getDoc, arrayUnion } from './src/firebase.js';
  import { withRetry, updateOrCreateDoc } from './src/firebase-helpers.js';

      function toYMD(d) {
        try {
          if (typeof d === 'string' && /\d{4}-\d{2}-\d{2}/.test(d)) return d.slice(0,10);
          const dt = new Date(d);
          if (!isNaN(dt)) return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
          return '';
        } catch { return ''; }
      }
      function formatDateNL(ymd) {
        try {
          const [y,m,d] = [ymd.slice(0,4), ymd.slice(5,7), ymd.slice(8,10)];
          const dt = new Date(Number(y), Number(m)-1, Number(d));
          return dt.toLocaleDateString('nl-NL', { day:'2-digit', month:'long', year:'numeric' });
        } catch { return ymd; }
      }

      async function renderManualPastRides(memberId) {
        const listEl = document.getElementById('manualPastRidesList');
        const statusEl = document.getElementById('manualPastRidesStatus');
        if (!listEl) return;
        listEl.innerHTML = '';
        if (statusEl) statusEl.textContent = '';

        try {
          const planned = await getPlannedDates();
          const today = new Date();
          const todayYMD = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
          const past = (Array.isArray(planned) ? planned : [])
            .map(toYMD)
            .filter(Boolean)
            .filter(d => d < todayYMD)
            .sort((a,b) => b.localeCompare(a));

          if (!past.length) {
            const empty = document.createElement('div');
            empty.className = 'muted';
            empty.textContent = 'Er zijn nog geen eerdere ritten.';
            listEl.appendChild(empty);
            return;
          }

          // Haal huidige ScanDatums op zodat we knoppen kunnen disablen waar nodig
          let existing = new Set();
          try {
            const snap = await getDoc(doc(db, 'members', String(memberId)));
            if (snap.exists()) {
              const data = snap.data() || {};
              existing = new Set((Array.isArray(data.ScanDatums) ? data.ScanDatums : []).map(toYMD).filter(Boolean));
            }
          } catch(_) {}

          past.forEach(ymd => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn';
            btn.style.textAlign = 'left';
            btn.style.justifyContent = 'space-between';
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.gap = '10px';
            btn.dataset.ymd = ymd;

            const label = formatDateNL(ymd);
            if (existing.has(ymd)) {
              btn.textContent = `‚úîÔ∏è ${label}`;
              btn.disabled = true;
              btn.setAttribute('aria-disabled', 'true');
            } else {
              btn.textContent = label;
            }

            btn.addEventListener('click', async () => {
                try {
                  btn.disabled = true;
                  btn.textContent = `${label} ‚Ä¢ opslaan‚Ä¶`;

                  // Read current document to compute numeric ridesCount (avoid relying on FieldValue.increment symbol)
                  let currentCount = 0;
                  try {
                    const snapCur = await getDoc(doc(db, 'members', String(memberId)));
                    if (snapCur.exists()) {
                      const dcur = snapCur.data() || {};
                      const rc = Number(dcur?.ridesCount);
                      currentCount = Number.isFinite(rc) ? rc : 0;
                    }
                  } catch (_) { /* ignore read errors and assume 0 */ }

                  const newCount = currentCount + 1;
                  console.debug('admin-scan: adding scandatum', { memberId, ymd, currentCount, newCount });

                  // Prefer update; fall back to merge-create if doc missing. Wrap in retry.
                  await withRetry(() => updateOrCreateDoc(doc(db, 'members', String(memberId)), { ScanDatums: arrayUnion(ymd), ridesCount: newCount }), { retries: 3 });

                  btn.textContent = `‚úîÔ∏è ${label}`;
                  existing.add(ymd);
                  if (statusEl) statusEl.textContent = `Rit ${label} toegevoegd aan ${memberId}.`;
                } catch (e) {
                  console.error('Handmatig boeken mislukt', e);
                  btn.disabled = false;
                  btn.textContent = label;
                  if (statusEl) statusEl.textContent = '‚ùå Opslaan mislukt. Controleer je verbinding of rechten.';
                }
            });

            listEl.appendChild(btn);
          });
        } catch (e) {
          console.error('Past rides render failed', e);
          if (statusEl) statusEl.textContent = '‚ùå Ritten laden mislukt.';
        }
      }

      // Observeer wijzigingen aan de leden-inschrijfsectie en render past rides bij selectie
      const resultEl = document.getElementById('result');
      const memberNoEl = document.getElementById('rMemberNo');
      let lastMemberId = '';

      function maybeRender() {
        const id = (memberNoEl?.textContent || '').trim();
        // Als er geen geldige selectie is, verberg het resultaatkader
        if (!id || id === '‚Äî') {
          if (resultEl) resultEl.style.display = 'none';
          return;
        }
        if (id === lastMemberId) return;
        lastMemberId = id;
        // Geldige selectie: toon resultaat en render lijst
        if (resultEl) { resultEl.style.display = 'grid'; resultEl.style.visibility = ''; }
        renderManualPastRides(id);
      }

      if (resultEl && memberNoEl) {
        const mo = new MutationObserver(() => {
          // Reageer op wijzigingen en bepaal zichtbaar/verborgen op basis van selectie
          maybeRender();
        });
        mo.observe(resultEl, { attributes: true, childList: true, subtree: true, characterData: true });
        // Eerste poging ook direct
        setTimeout(() => maybeRender(), 300);
      }

      // Zorg dat na keuze Jaarhanger de gegevens-sectie in beeld komt
      function ensureResultVisibleAndScroll() {
        const id = (memberNoEl?.textContent || '').trim();
        if (!id || id === '‚Äî') return; // geen selectie, niets tonen
        if (resultEl) {
          resultEl.style.display = 'grid';
          resultEl.style.visibility = '';
          // Laat de browser eerst lay-outen en scroll dan vloeiend in beeld
          setTimeout(() => {
            try { resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
          }, 50);
        }
      }

      const yhYes = document.getElementById('yearhangerYes');
      const yhNo = document.getElementById('yearhangerNo');
      yhYes?.addEventListener('click', ensureResultVisibleAndScroll);
      yhNo?.addEventListener('click', ensureResultVisibleAndScroll);
    </script>
    <script type="module">
      // Alleen initializer voor Admin Landelijke Signup; de lid-inschrijvingssectie gebruikt de logica uit member.js/main.js
      import { initMemberSearchSection } from './src/member-search-ui.js';

      initMemberSearchSection({
        nameInputId: 'adminSignupNameInput',
        suggestionsListId: 'adminSignupSuggestions',
        errorId: 'adminSignupError',
        loadingId: 'adminSignupLoading',
        resultBoxId: 'adminSignupResult',
        fields: {
          nameId: 'adminSignupName',
          memberNoId: 'adminSignupMemberNo',
          ridesCountId: 'adminSignupRidesCount',
          regionId: 'adminSignupRegion',
        },
        withQr: true,
        qrCanvasId: 'adminSignupQrCanvas',
        qrPrivacyTextId: 'adminSignupQrPrivacy',
        enableQrFullscreen: true,
      });

      // Maak de gekopieerde leden-inschrijfsectie zichtbaar in admin (consent-gate is niet van toepassing hier)
      setTimeout(() => {
        const signup = document.getElementById('landelijkeSignup');
        if (signup) {
          signup.removeAttribute('hidden');
          signup.style.display = '';
        }
      }, 150);
    </script>
    
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
