// scripts/gen-firebase-config.js
// Generates assets/firebase-runtime-config.js from environment variables.
// Usage: NODE_ENV=production node scripts/gen-firebase-config.js

const fs = require('fs');
const path = require('path');

// Load .env when running locally
try {
  require('dotenv').config();
} catch (_) {}

function readEnv(prefix, key) {
  return process.env[`${prefix}${key}`] || '';
}

function buildConfig(target) {
  const p = target === 'dev' ? 'FIREBASE_DEV_' : 'FIREBASE_PROD_';
  const keys = ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'];
  const cfg = {};
  keys.forEach(k => { cfg[k] = readEnv(p, k); });
  return { env: target, config: cfg };
}

function ensureDir(dir) {
  try { fs.mkdirSync(dir, { recursive: true }); } catch (_) {}
}

function main() {
  const target = (process.env.SHADOW_TARGET === 'dev' || process.env.SHADOW_TARGET === 'prod') ? process.env.SHADOW_TARGET : (process.env.VERCEL_ENV === 'development' ? 'dev' : 'prod');
  const outObj = buildConfig(target);
  const outPath = path.join(__dirname, '..', 'assets', 'firebase-runtime-config.js');
  ensureDir(path.dirname(outPath));
  const contents = `// Generated by scripts/gen-firebase-config.js â€” DO NOT EDIT\nwindow.__FIREBASE_RUNTIME_CONFIG = ${JSON.stringify(outObj, null, 2)};\n`;
  fs.writeFileSync(outPath, contents, 'utf8');
  console.log('Wrote', outPath, 'with env=', outObj.env);
}

main();
