<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hoofdadmin – Dev tools</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand">Shadow App</div>
      <nav class="nav" aria-label="Hoofdnavigatie">
        <a href="/" class="tab" id="btnMember">Lid</a>
        <a href="/admin-scan.html" class="tab" id="btnAdmin">Inschrijftafel</a>
      </nav>
    </header>

    <main class="wrap">

      <div class="admin-nav-dropdown">
        <select id="adminNavSelect" class="admin-nav-select">
          <option value="admin-scan.html">Inschrijftafel</option>
          <option value="admin-planning.html">Begin van het jaar</option>
          <option value="admin-passwords.html">Wachtwoorden</option>
          <option value="admin-stats.html">Ritten data</option>
          <option value="admin-lunch.html">Lunch inplannen</option>
                      <option value="admin-excel.html">Excel import / export</option>

          <option value="admin-dev.html" selected>Dev</option>
        </select>
      </div>

      <section class="card">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
          <h2 style="margin:0;">Reset acties</h2>
        </div>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap;">
          <button id="resetJaarhangerBtn" class="btn" style="border-color:#ef4444;">⚠️ Reset alle Jaarhanger </button>
          <span id="resetJaarhangerStatus" class="status"></span>
        </div>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <button id="resetLunchBtn" class="btn" style="border-color:#ef4444;">⚠️ Reset alle lunchgegevens</button>
          <span id="resetLunchStatus" class="status"></span>
        </div>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <button id="clearScanDatumsBtn" class="btn" style="border-color:#ef4444;">⚠️ Reset alle ScanDatums</button>
          <span id="clearScanDatumsStatus" class="status"></span>
        </div>
      </section>
    </main>

    <script type="module">
      import { checkAdminAuth, applyAdminLevel } from '/src/auth.js';
      import { initAdminView } from '/src/admin.js';
      import { db, collection, query, orderBy, startAfter, limit, getDocs, writeBatch, doc } from '/src/firebase.js';

      // Dropdown navigation handler
      const navSelect = document.getElementById('adminNavSelect');
      if (navSelect) {
        navSelect.addEventListener('change', (e) => {
          window.location.href = e.target.value;
        });
      }

      // Alleen root admins voor deze pagina
      if (checkAdminAuth()) {
        const adminLevel = sessionStorage.getItem("admin_level");
        if (adminLevel !== "root") {
          window.location.href = "admin-scan.html";
        } else {
          applyAdminLevel();
          initAdminView();

          // Clear all ScanDatums (DEV) — paged + batched updates
          const clearBtn = document.getElementById('clearScanDatumsBtn');
          const clearStatus = document.getElementById('clearScanDatumsStatus');
          if (clearBtn) {
            clearBtn.addEventListener('click', async () => {
              if (!confirm('Weet je het zeker? Dit verwijdert alle ScanDatums en zet ridesCount naar 0 voor ALLE leden.')) return;
              clearBtn.disabled = true;
              clearStatus.textContent = 'Bezig…';
              try {
                let updated = 0;
                let skipped = 0;
                const pageSize = 400;
                let last = null;
                while (true) {
                  const q = last ? query(collection(db, 'members'), orderBy('__name__'), startAfter(last), limit(pageSize)) : query(collection(db, 'members'), orderBy('__name__'), limit(pageSize));
                  const snap = await getDocs(q);
                  if (snap.empty) break;

                  const batch = writeBatch(db);
                  snap.forEach(d => {
                    const data = d.data() || {};
                    const hasScan = Array.isArray(data.ScanDatums) && data.ScanDatums.length > 0;
                    const needsZero = Number(data.ridesCount) !== 0;
                    if (hasScan || needsZero) {
                      const ref = doc(db, 'members', d.id);
                      batch.update(ref, { ScanDatums: [], ridesCount: 0 });
                      updated += 1;
                    } else {
                      skipped += 1;
                    }
                  });

                  // If batch has updates, commit it
                  if (updated % pageSize !== 0 || updated > 0) {
                    await batch.commit();
                  }

                  last = snap.docs[snap.docs.length - 1];
                  if (snap.size < pageSize) break;
                }

                clearStatus.textContent = `✅ Klaar — bijgewerkt: ${updated}, overgeslagen: ${skipped}`;
              } catch (e) {
                console.error('Clear ScanDatums failed', e);
                clearStatus.textContent = '❌ Mislukt: ' + (e?.message || e);
              } finally {
                clearBtn.disabled = false;
              }
            });
          }
        }
      }
    </script>

    <script type="module" src="/src/main.js"></script>
  </body>
</html>
